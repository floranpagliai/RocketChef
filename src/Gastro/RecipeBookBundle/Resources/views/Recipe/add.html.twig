{% extends 'GastroRecipeBookBundle::layout.html.twig' %}

{% block page_content_header %}
    {{ 'recipebook.title'|trans }}
    <small>{{ 'recipebook.add.comment'|trans }}</small>
{% endblock %}

{% block page_content_breadcrumb %}
    <li><a href="{{ path('gastro_dashboard') }}"><i class="fa fa-tachometer "></i> {{ 'dashboard.title'|trans }}</a>
    </li>
    <li><a href="{{ path('gastro_recipe_book') }}"><i class="fa fa-book"></i> {{ 'recipebook.title'|trans }}</a>
    </li></a>
    <li class="active"><i class="fa fa-cutlery"></i> {{ 'recipebook.add.new'|trans }}</li></a>
{% endblock %}

{% block page_content %}
    <div class="col-lg-12">
        {% form_theme form _self %}
        <form method="POST" {{ form_enctype(form) }}>
            <div class="portlet portlet-default">
                <div class="portlet-heading">
                    <div class="portlet-title">
                        <h4>{{ 'recipebook.add.comment'|trans }}</h4>
                    </div>
                    <div class="portlet-widgets">
                        <input class="btn btn-xs btn-blue" type="submit" id="_submit" name="_submit"
                               value="{{ 'recipebook.add.submit'|trans }}"/>
                    </div>
                    <div class="clearfix"></div>
                </div>
                <div id="defaultPortlet" class="panel-collapse in" style="height: auto;">
                    <div class="portlet-body">

                        <h3>Recipe</h3>

                        <div class="form-inline">
                            <div class="form-group">
                                <label for="recipe_name">Recipe name</label>
                                {{ form_widget(form.name) }}
                            </div>
                            <div class="form-group">
                                <label for="recipe_prtions">Portions</label>
                                {{ form_widget(form.portions) }}
                            </div>
                            <div class="form-group">
                                <label for="recipe_price">Selling Price</label>
                                {{ form_widget(form.price) }}
                            </div>
                        </div>

                        <h3>Ingredients</h3>

                            <table class="table">
                                <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Quantity</td>
                                    <td>Unit</td>
                                    <td>Price</td>
                                    <td>Unit price</td>
                                    <td width="8%"></td>
                                </tr>
                                </thead>

                                {% macro tagCollectionItem(formData) %}
                                        <td>
                                            {{ form_widget(formData.ingredient.name) }}
                                        </td>
                                        <td>
                                            {{ form_widget(formData.qte) }}
                                        </td>
                                        <td>
                                            {{ form_widget(formData.unit) }}
                                        </td>
                                        <td>
                                            {{ form_widget(formData.ingredient.priceForUnit) }}
                                        </td>
                                        <td>
                                            {{ form_widget(formData.ingredient.unit) }}
                                        </td>
                                {% endmacro %}
                                <tbody class="ingredients" data-prototype="{{ _self.tagCollectionItem(form.RecipeIngredient.vars.prototype)|e }}">
                                    {% for RecipeIngredient in form.RecipeIngredient %}
                                        <tr>
                                        {{ _self.tagCollectionItem(RecipeIngredient) }}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>


                        {{ form_widget(form._token) }}
                        {#<input class="btn btn-xs btn-blue" type="submit" id="_submit" name="_submit"#}
                        {#value="{{ 'recipebook.add.submit'|trans }}"/>#}
                    </div>
                </div>
            </div>
        </form>

    </div>

    {% block page_script %}
        <script type="text/javascript">
            var collectionHolder = $('tbody.ingredients');

            // ajoute un lien « add a tag »
            var $addTagLink = $('<a href="#" class="btn btn-sm btn-primary add_tag_link"><i class="fa fa-plus"></i> Add a ingredient</a>');

            var $newLinkLi = $addTagLink;

            jQuery(document).ready(function () {
                // ajoute l'ancre « ajouter un tag » et li à la balise ul
                collectionHolder.append($newLinkLi);

                $addTagLink.on('click', function (e) {
                    // empêche le lien de créer un « # » dans l'URL
                    e.preventDefault();

                    // ajoute un nouveau formulaire tag (voir le prochain bloc de code)
                    addTagForm(collectionHolder, $newLinkLi);
                });

                collectionHolder.find('tr').each(function () {
                    addTagFormDeleteLink($(this));
                });
            });

            function addTagForm(collectionHolder, $newLinkLi) {
                // Récupère l'élément ayant l'attribut data-prototype comme expliqué plus tôt
                var prototype = collectionHolder.attr('data-prototype');

                // Remplace '__name__' dans le HTML du prototype par un nombre basé sur
                // la longueur de la collection courante
                var newForm = prototype.replace(/__name__/g, collectionHolder.children().length);

                // Affiche le formulaire dans la page dans un li, avant le lien "ajouter un tag"
                var $newFormLi = $('<tr></tr>').append(newForm);
                $newLinkLi.before($newFormLi);
                addTagFormDeleteLink($newFormLi);
            }

            function addTagFormDeleteLink($tagFormLi) {
                var $removeFormA = $('<td class="tooltip-content"><a href="#" class="btn btn-sm btn-red btn-block" data-toggle="tooltip" ' +
                        'data-placement="top" data-original-title="Delete ingredient"><i class="fa fa-times"></i></a></td>');

                $tagFormLi.append($removeFormA);

                $removeFormA.on('click', function (e) {
                    // empêche le lien de créer un « # » dans l'URL
                    e.preventDefault();

                    // supprime l'élément li pour le formulaire de tag
                    $tagFormLi.remove();
                });
            }
        </script>
    {% endblock %}

{% endblock %}
